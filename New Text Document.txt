import requests
import json
import random
import base64
from datetime import datetime

# --- CONFIGURATION BLOCK (USER MUST EDIT) -----------------------------------
# The URL of your WordPress site's REST API endpoint
WP_URL = "https://perryrobert2-kivrq.wpcomstaging.com/news" 
# Your WordPress Username (the one you used to generate the App Password)
WP_USER = "perryrobert2" 
# The Application Password provided
WP_APP_PASSWORD = "HyLZ ImcD Jvi1 TH7w 41vs o427"
# --- END CONFIGURATION ------------------------------------------------------

# --- TOOL IMPORTS AND SETUP (Simulated Brain/Config) -------------------------
# NOTE: In a real environment, you would call your 'newsroom/brain.py' module.
# We simulate the API call here using a simple function for demonstration.
# Please ensure the gemini-2.5-pro model is used for the critical Editorial/Crank content.

def generate_text_content(prompt, model_type="flash"):
    """
    Placeholder for the actual Gemini API call (brain.think).
    In your live script, this would call your custom brain.py module.
    """
    # Placeholder response based on the persona tone
    if "Editor" in prompt:
        return "Furthermore, the current political duopoly exhibits a profound failure of nerve and imagination. The Northern Beaches deserves representation that isn't afraid to look beyond the two major parties. They should be ashamed of this blatant disregard for the public good, hitherto unseen in modern times. I smell treats."
    elif "Crank" in prompt:
        return "I'm sick of these young people complaining about the bus lanes! It's the same agenda as the people demanding new immigration quotas! If they can't manage a simple timetable, how can they manage global policy? It all links back to the price of fuel, which, by the way, has been rigged since 1987. Disgusted and furious."
    else:
        return "This story has been automatically generated by the Brain. It is functional and politically neutral."

# --- PERSONA DATA (For the Injection Logic) ---------------------------------

PERSONAS = {
    "EDITOR": {"name": "Remy (Editor-in-Chief)", "style": "Pompous, authoritative"},
    "CLOWN": {"name": "Puddles (The Truth Teller)", "style": "Cynical, exposing"},
    "POLICE": {"name": "Sergeant Stubby", "style": "Official jargon"},
    "MYSTIC": {"name": "The Great Remdini", "style": "Cryptic, historical"},
    "NETBALL_MUM": {"name": "Karen (The Admin)", "style": "Passive-aggressive"},
    "CRANK": {"name": "Disgusted of Cromer", "style": "Ranting, non-sequitur"}
}

# --- TEMPLATE DEFINITION (Matches your WordPress Setup) ---------------------

def get_html_structure(title, body, snipe=""):
    """Wraps the content in the structure needed for Gutenberg/Styling."""
    
    # The default WordPress high-contrast style is usually enough if you use HTML tags.
    # The snipe is wrapped in the style we discussed (Yellow background, Marker font)
    clown_snipe_html = f"""
    <div style="background-color: #FFFBEB; border: 1px dashed #000000; padding: 15px; margin-top: 20px; font-family: 'Permanent Marker', cursive; font-size: 1.1em; transform: rotate(-1deg);">
        **REALITY CHECK:** {snipe}
    </div>
    """ if snipe else ""

    # The content is structured with the Clown Snipe at the end.
    return f"{body}{clown_snipe_html}"

# --- CONTENT GENERATORS (The Brain Logic) -----------------------------------

def generate_editorial(topic):
    # Logic: Direct Political Satire (The Editor)
    prompt = f"You are {PERSONAS['EDITOR']['name']}. Write a 150-word editorial satirizing the current political duopoly's failure on {topic}. Tone: {PERSONAS['EDITOR']['style']}. Focus on action vs. rhetoric."
    text = generate_text_content(prompt, "pro")
    
    # Simulating image upload via Python and getting its URL
    image_url = "https://your-site.com/wp-content/uploads/editor_remy.jpg" 

    return {
        "title": f"Editorial: {topic}",
        "content": text,
        "author": PERSONAS['EDITOR']['name'],
        "category_id": 1, # Placeholder for News Category ID
        "image_url": image_url,
        "raw_text": text # Needed for the Clown to read later
    }

def generate_crank_letter(topic_pivot):
    # Logic: Guilt by Association (The Crank)
    prompt = f"You are {PERSONAS['CRANK']['name']}. Write a short letter (100 words) complaining about a local issue (parking/bins) but pivot aggressively to an anti-immigration/anti-taxation rant, linking the two. Tone: {PERSONAS['CRANK']['style']}."
    text = generate_text_content(prompt, "flash")
    return {
        "title": "Letters: Disgusted of Cromer",
        "content": text,
        "author": PERSONAS['CRANK']['name'],
        "category_id": 2, # Placeholder for Lifestyle Category ID
        "image_url": "https://your-site.com/wp-content/uploads/crank_bins.jpg",
        "raw_text": text
    }

def generate_clown_injection(editorial_text, crank_text):
    # Logic: The Needle - Puddles exposes the 'Dead Cat'
    # Puddles needs to read the *disguise* (the editorial and the crank letter)
    
    prompt = f"You are Puddles, {PERSONAS['CLOWN']['style']} commentator. Read these two stories: [1. {editorial_text}] and [2. {crank_text}]. Write a single, 2-sentence cynical truth that connects these two separate distractions and exposes what the Duopoly is ACTUALLY trying to hide (e.g., their voting record). Tone: Sad, brilliant, critical."
    return generate_text_content(prompt, "pro")

# --- DELIVERY SYSTEM (The Courier) ------------------------------------------

def post_to_wordpress(post_data):
    """
    Authenticates and sends the generated post to the WordPress REST API.
    """
    
    # 1. Base64 encode the username and app password for Basic Auth
    credentials = f"{WP_USER}:{WP_APP_PASSWORD}"
    token = base64.b64encode(credentials.encode())
    
    headers = {
        'Authorization': f'Basic {token.decode("utf-8")}',
        'Content-Type': 'application/json'
    }
    
    # 2. Construct the Post Payload
    payload = {
        'title': post_data['title'],
        # IMPORTANT: Content is wrapped in the final styled HTML structure
        'content': post_data['final_html'], 
        'status': 'publish',
        'categories': [post_data['category_id']],
        # You would also set the 'featured_media' ID here after uploading the image
    }
    
    try:
        response = requests.post(WP_URL, headers=headers, json=payload)
        response.raise_for_status() # Raise an exception for bad status codes
        print(f"✅ Success: Posted '{post_data['title']}' to WordPress.")
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"❌ Error posting to WordPress (Check URL/Credentials): {e}")
        return None

# --- MAIN ORCHESTRATOR ------------------------------------------------------

def run_press_run():
    # 1. Get Today's Topic from Scout (Simulated)
    # In the live script, this would parse NEWS_DUMP_FILE.
    daily_topic = "The Council's New Secret Debt Bill"
    
    # 2. Generate the Balloons (The Distractions)
    editorial = generate_editorial(daily_topic)
    crank_letter = generate_crank_letter("Bin Day Change")

    # 3. Generate the Injection (The Needle)
    clown_snipe = generate_clown_injection(editorial['raw_text'], crank_letter['raw_text'])
    
    # 4. Final Assembly and Publishing
    print("\n--- Publishing Final Issues ---")

    # --- NEWS DESK ---
    # The Clown's snipe is added to the Editorial post
    final_editorial_html = get_html_structure(
        editorial['title'], 
        editorial['content'], 
        snipe=clown_snipe # Injecting the Clown's commentary here
    )
    
    editorial_post = {
        **editorial,
        "final_html": final_editorial_html,
    }
    
    post_to_wordpress(editorial_post)
    
    # Note: Other desks (Lifestyle/Arts/Sports) would be generated and posted here.

if __name__ == "__main__":
    run_press_run()